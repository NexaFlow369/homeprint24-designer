<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>HomePrint24 ‚Äì 3D Binder PokePate Editor</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fjalla+One&display=swap');

    :root{
      --bg-dark:#0f172a;
      --bg-panel:#e5e7eb;
      --card:#f9fafb;
      --accent:#2563eb;
      --accent-soft:#dbeafe;
      --text-dark:#0f172a;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      padding:0;
      background:var(--bg-dark);
      color:var(--bg-panel);
      font-family:'Fjalla One',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
    }

    #hpt24{
      max-width:1180px;
      margin:24px auto;
      background:var(--bg-panel);
      padding:16px;
      border-radius:18px;
      box-shadow:0 16px 45px rgba(15,23,42,.45);
    }

    .hpt24-title{
      text-align:center;
      margin:8px 0 16px;
      color:#0f172a;
      font-weight:800;
      letter-spacing:.3px;
    }

    #hpt24-tabs{
      display:flex;
      justify-content:center;
      margin-bottom:12px;
      gap:8px;
    }
    .ld-tab{
      padding:8px 16px;
      border-radius:999px;
      border:1px solid #cbd5e1;
      background:#fff;
      cursor:pointer;
      font-size:12px;
      font-weight:700;
    }
    .ld-tab.active{
      background:#111827;
      color:#fff;
      border-color:#111827;
    }

    .hpt24-layout{
      display:grid;
      grid-template-columns:minmax(0,1.25fr) minmax(0,1.15fr);
      gap:18px;
      align-items:flex-start;
    }

    .hpt24-left,
    .hpt24-right{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .hpt24-right{
      border-left:1px solid #d1d5db;
      padding-left:14px;
    }

    .ld-card{
      background:var(--card);
      border-radius:14px;
      padding:14px;
      border:1px solid #e5e7eb;
    }

    .ld-label{
      font-weight:800;
      color:var(--text-dark);
      margin-bottom:4px;
    }
    .ld-sublabel{
      font-weight:600;
      color:var(--text-dark);
      font-size:13px;
    }

    .ld-input{
      padding:10px;
      border-radius:10px;
      border:1px solid #cbd5e1;
      width:100%;
      background:#fff;
      font-size:13px;
    }

    .ld-btn{
      padding:7px 10px;
      border:none;
      border-radius:9px;
      background:#e2e8f0;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
    }
    .ld-btn.primary{
      background:#111827;
      color:#fff;
      font-weight:800;
    }
    .ld-btn.accent{
      background:#0ea5e9;
      color:#fff;
      font-weight:800;
    }

    .hpt24-grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .hpt24-gap-top{margin-top:8px;}

    /* PREVIEW / CANVAS */
    .ld-preview-shell{
      position:relative;
      background:#ffffff;
      border-radius:18px;
      box-shadow:0 12px 32px rgba(15,23,42,.18);
      padding:10px 10px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    #ld-canvas{
      width:100%;
      display:block;
      border-radius:16px;
      background:#f9fafb;
    }

    .ld-preview-hint{
      position:absolute;
      left:16px;
      bottom:18px;
      background:rgba(15,23,42,.84);
      color:#fff;
      padding:6px 10px;
      border-radius:8px;
      font-size:11px;
    }

    .ld-color-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:#f9fafb;
      border-radius:999px;
      padding:6px 10px;
      border:1px solid #e5e7eb;
    }
    .ld-swatches-row{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .ld-swatch{
      width:22px;
      height:22px;
      border-radius:6px;
      border:1px solid #d1d5db;
      cursor:pointer;
    }

    /* LAYER / PRESET */
    .ld-layer-card{margin-top:4px;}
    .hpt24-preset-wrap{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .hpt24-preset-row{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .hpt24-range{width:100%;}
    .hpt24-subval{font-size:12px;color:#64748b;}

    .hpt24-layer-buttons{
      display:flex;
      justify-content:flex-end;
      align-items:flex-end;
      gap:6px;
      margin-top:8px;
    }
    .hpt24-small-btn{padding:5px 8px;font-size:11px;}

    .hpt24-row-between{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .hpt24-upload-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:8px;
    }
    .ld-upload-row{
      display:grid;
      grid-template-columns:minmax(0,1.4fr) auto auto auto auto;
      gap:4px;
      align-items:center;
    }
    .hpt24-sw-toggle{
      font-size:10px;
      display:flex;
      align-items:center;
      gap:4px;
    }

    .hpt24-notes{
      height:84px;
      resize:vertical;
    }

    /* QUALIT√ÑT */
    .ld-quality-wrap{margin-top:0;}
    .quality-row{display:flex;gap:6px;}
    .q-btn{
      padding:6px 10px;
      font-size:12px;
      border-radius:999px;
      border:1px solid #cbd5e1;
      background:#fff;
      cursor:pointer;
      font-weight:700;
    }
    .q-btn.active{
      background:#111827;
      color:#fff;
      border-color:#111827;
    }

    /* CART */
    .ld-cart-card{
      margin:6px auto 0;
      border-top:2px solid #0f172a;
      box-shadow:0 6px 18px rgba(15,23,42,.12);
      padding-top:10px;
    }
    .ld-cart-row{
      display:grid;
      grid-template-columns:minmax(0,1.7fr) auto auto auto;
      gap:8px;
      align-items:center;
      background:#e5e7eb;
      border-radius:12px;
      padding:8px;
      border:1px solid #d1d5db;
    }
    .ld-cart-row .ld-chip{
      padding:1px 8px;
      border-radius:999px;
      border:1px solid #cbd5e1;
      background:#fff;
      font-size:10px;
      margin-left:4px;
    }
    .hpt24-total{font-weight:800;color:#0f172a;}
    .hpt24-cart-list{margin-top:8px;display:flex;flex-direction:column;gap:8px;}
    .hpt24-checkout-btn{margin-top:10px;width:100%;}
    .hpt24-hint-text{font-size:11px;color:#64748b;margin-top:6px;line-height:1.4;}

    .hpt24-footer{
      text-align:center;
      font-size:12px;
      color:#64748b;
      margin-top:10px;
    }

    #promo-hint{
      font-size:11px;
      color:#10b981;
      margin-top:4px;
    }

    @media(max-width:900px){
      .hpt24-layout{
        grid-template-columns:1fr;
      }
      .hpt24-right{
        border-left:none;
        padding-left:0;
      }
    }

    @media(max-width:600px){
      .ld-cart-row{
        grid-template-columns:1fr 1fr;
        grid-auto-rows:auto;
      }
      .ld-upload-row{
        grid-template-columns:1fr 1fr;
        grid-template-rows:auto auto;
      }
    }
  </style>
</head>
<body>
<div id="hpt24">
  <h2 class="hpt24-title">HomePrint24 ‚Äì Print Your Legacy</h2>

  <div id="hpt24-tabs">
    <button class="ld-tab active" data-prod="binder">Binder PokePate</button>
  </div>

  <div class="hpt24-layout">

    <!-- LINKE SEITE: Canvas + Farbe + PRESET UNTEN -->
    <div class="hpt24-left">

      <!-- Preview / Live-Bild -->
      <div class="ld-preview-shell">
        <canvas id="ld-canvas" width="900" height="1100"></canvas>
        <div clas="ld-preview-hint">
                 </div>
        <div class="ld-color-bar">
          <span class="ld-sublabel">Farben</span>
          <div id="ld-swatches" class="ld-swatches-row"></div>
        </div>
      </div>

      <!-- PRESET / LAYER CONTROLS ‚Äì LINKS UNTEN -->
      <div class="ld-card ld-layer-card">
        <div class="hpt24-grid-2 hpt24-gap-top">
          <div>
            <div class="hpt24-preset-wrap">
              <span class="ld-sublabel">Preset:</span>
              <div class="hpt24-preset-row">
                <button class="ld-btn" data-preset="center">Center</button>
                <button class="ld-btn" data-preset="back">Back-Tag</button>
              </div>
            </div>
          </div>
          <div>
            <label class="ld-sublabel">
              Skalierung <span id="ld-scale-val" class="hpt24-subval">(100%)</span>
            </label>
            <input id="ld-scale" type="range" min="5" max="400" value="100" class="hpt24-range">
          </div>
        </div>

        <div class="hpt24-grid-2 hpt24-gap-top">
          <div>
            <label class="ld-sublabel">
              Rotation <span id="ld-rot-layer-val" class="hpt24-subval">(0¬∞)</span>
            </label>
            <input id="ld-rot-layer" type="range" min="-180" max="180" value="0" class="hpt24-range">
          </div>
          <div>
            <label class="ld-sublabel">
              Deckkraft <span id="ld-opa-val" class="hpt24-subval">(100%)</span>
            </label>
            <input id="ld-opa" type="range" min="5" max="100" value="100" class="hpt24-range">
          </div>
        </div>

        <div class="hpt24-layer-buttons">
          <button id="ld-layer-vis" class="ld-btn hpt24-small-btn">Sichtbar: AN</button>
          <button id="ld-layer-del" class="ld-btn hpt24-small-btn">Layer l√∂schen</button>
        </div>
      </div>

    </div>

    <!-- RECHTE SEITE: Upload + Bestellangaben + WARENKORB UNTEN -->
    <div class="hpt24-right">

      <!-- Upload / Ansicht -->
      <div class="ld-card">
        <div class="hpt24-row-between">
          <label class="ld-label" style="margin:0;">Dein Motiv hochladen</label>
          <div class="hpt24-row-between" style="gap:6px;">
            <span class="ld-sublabel">Ansicht:</span>
            <span id="ld-view-badge" class="ld-sublabel">FRONT</span>
            <button class="ld-btn" data-view="front">Front</button>
            <button class="ld-btn" data-view="back">Back</button>
          </div>
        </div>
        <div id="ld-uploader-list" class="hpt24-upload-list"></div>
      </div>

      <!-- Bestellangaben -->
      <div class="ld-card">
        <label class="ld-label">Bestellangaben</label>

        <div class="hpt24-grid-2 hpt24-gap-top">
          <select id="ld-size" class="ld-input">
            <option value="">Format</option>
            <option value="Standard">Standard</option>
          </select>
          <select id="ld-color-select" class="ld-input"></select>
        </div>

        <div class="hpt24-grid-2 hpt24-gap-top">
          <div class="ld-quality-wrap">
            <label class="ld-sublabel">Qualit√§t</label>
            <div class="quality-row">
              <button class="q-btn active" data-q="standard">Standard</button>
            </div>
          </div>
          <select id="ld-gender" class="ld-input">
            <option value="">Variante</option>
            <option value="pokepate">PokePate Edition</option>
          </select>
        </div>

        <!-- Hidden Select f√ºr Logik -->
        <select id="ld-quality" style="display:none;">
          <option value="standard" selected>standard</option>
        </select>

        <div class="hpt24-gap-top">
          <label class="ld-sublabel">St√ºckzahl & Preis</label>
          <div class="hpt24-grid-2 hpt24-gap-top">
            <input id="ld-qty" type="number" min="1" value="1" class="ld-input" placeholder="St√ºckzahl">
            <input id="ld-price" type="text" class="ld-input" value="0,00 ‚Ç¨" readonly>
          </div>
        </div>

        <div class="hpt24-gap-top">
          <label class="ld-sublabel">Promocode</label>
          <input id="ld-promocode" class="ld-input" placeholder="z. B. HP24-10">
          <p id="promo-hint" style="display:none;">Rabatt angewendet.</p>
        </div>

        <textarea id="ld-notes" class="ld-input hpt24-notes hpt24-gap-top"
          placeholder="W√ºnsche/Anmerkungen (z. B. Logo mittig, Rand frei lassen ‚Ä¶)"></textarea>

        <div class="hpt24-grid-2 hpt24-gap-top">
          <button id="ld-add" class="ld-btn primary">In den Warenkorb</button>
          <button id="ld-download" class="ld-btn">Mockup herunterladen</button>
        </div>
      </div>

      <!-- Warenkorb ‚Äì RECHTS UNTEN -->
      <div class="ld-card ld-cart-card">
        <div class="hpt24-row-between">
          <div class="ld-label" style="margin:0;">Warenkorb</div>
          <div id="ld-total" class="hpt24-total">0,00 ‚Ç¨</div>
        </div>
        <div id="ld-cart" class="hpt24-cart-list"></div>
        <button id="ld-checkout" class="ld-btn accent hpt24-checkout-btn">Zur Kasse</button>
        <p class="hpt24-hint-text">
          Der Gesamtpreis basiert auf Binder-Qualit√§t, Motivanzahl und Druckart.
          Bitte Mockup vor Checkout speichern.
        </p>
      </div>

    </div>
  </div>

  <p class="hpt24-footer">¬© HomePrint24 ‚Äì Print Your Legacy</p>
</div>

<script>
(function(){
  // --- PREISE ---
  const BASE_PRICE = {
    standard: 34.49   // Binder PokePate blanko
  };

  const MOTIF_PRICE = { bw:3.50, color:5.50 };

  // --- FARBEN BINDER (nur schwarz) ---
  const COLORS_BINDER = ['black'];

  const COLOR_NAME = {
    black:'Black'
  };

  const COLOR_HEX = {
    black:'#111827'
  };

  function currentPalette(){
    return COLORS_BINDER;
  }

  // --- BILDQUELLEN (BINDER) ---
  const FRONT_BINDER = {
    black:'https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_9164.jpeg/:/rs=w:1440,h:1440'
  };

  const BACK_BINDER = {
    black:'https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_9164.jpeg/:/rs=w:1440,h:1440'
  };

  const IMAGE_CACHE = {};
  function loadImage(src){
    if(IMAGE_CACHE[src]) return IMAGE_CACHE[src];
    const im = new Image();
    im.crossOrigin = 'anonymous';
    im.src = src;
    IMAGE_CACHE[src] = im;
    im.onload = () => draw();
    return im;
  }

  // --- STATE ---
  const canvas = document.getElementById('ld-canvas');
  const ctx = canvas.getContext('2d');

  let view = 'front';       // front / back
  let color = 'black';
  let selectedQuality = 'standard';
  let promoDiscount = 0;

  const LAYER_COUNT = 3;
  const makeLayer = () => ({
    img:null,x:0,y:0,
    scale:1,rot:0,op:1,
    vis:true,bw:false,name:''
  });
  const layersFront = Array.from({length:LAYER_COUNT},makeLayer);
  const layersBack  = Array.from({length:LAYER_COUNT},makeLayer);
  let layers = layersFront;
  let active = 0;

  // --- DOM ---
  const colorSel   = document.getElementById('ld-color-select');
  const sizeEl     = document.getElementById('ld-size');
  const qualityEl  = document.getElementById('ld-quality');
  const genderEl   = document.getElementById('ld-gender');
  const qtyEl      = document.getElementById('ld-qty');
  const priceEl    = document.getElementById('ld-price');
  const viewBadge  = document.getElementById('ld-view-badge');
  const uploadsBox = document.getElementById('ld-uploader-list');
  const promoInput = document.getElementById('ld-promocode');
  const promoHint  = document.getElementById('promo-hint');

  const scaleEl    = document.getElementById('ld-scale');
  const scaleVal   = document.getElementById('ld-scale-val');
  const rotEl      = document.getElementById('ld-rot-layer');
  const rotVal     = document.getElementById('ld-rot-layer-val');
  const opaEl      = document.getElementById('ld-opa');
  const opaVal     = document.getElementById('ld-opa-val');
  const visBtn     = document.getElementById('ld-layer-vis');
  const delBtn     = document.getElementById('ld-layer-del');

  const cartBox    = document.getElementById('ld-cart');
  const totalEl    = document.getElementById('ld-total');

  const cart = [];

  // --- FARBAUSWAHL ---
  function renderColorSelect(){
    const palette = currentPalette();
    colorSel.innerHTML = '';
    palette.forEach(k=>{
      const opt = document.createElement('option');
      opt.value = k;
      opt.textContent = COLOR_NAME[k] || k;
      colorSel.appendChild(opt);
    });
    if(!palette.includes(color)) color = palette[0];
    colorSel.value = color;
  }

  function renderSwatches(){
    const host = document.getElementById('ld-swatches');
    host.innerHTML = '';
    const palette = currentPalette();
    palette.forEach(k=>{
      const sw = document.createElement('div');
      sw.className = 'ld-swatch';
      sw.style.background = COLOR_HEX[k] || '#e5e7eb';
      if(k === color){
        sw.style.outline = '2px solid #111827';
        sw.style.outlineOffset = '1px';
      }
      sw.title = COLOR_NAME[k] || k;
      sw.onclick = ()=>{
        color = k;
        renderColorSelect();
        draw();
      };
      host.appendChild(sw);
    });
  }

  colorSel.addEventListener('change', e=>{
    color = e.target.value;
    renderSwatches();
    draw();
  });

  // --- VIEW FRONT/BACK ---
  function setView(v){
    view = v === 'back' ? 'back' : 'front';
    layers = view === 'front' ? layersFront : layersBack;
    viewBadge.textContent = view.toUpperCase();
    active = 0;
    renderUploadRows();
    syncUIFromLayer();
    draw();
  }

  document.querySelectorAll('[data-view]').forEach(btn=>{
    btn.addEventListener('click',()=> setView(btn.dataset.view));
  });

  // --- BASE IMAGE ---
  function getBaseImage(){
    const palette = currentPalette();
    if(!palette.includes(color)){
      color = palette[0];
      renderColorSelect();
      renderSwatches();
    }
    const mapFront = FRONT_BINDER;
    const mapBack  = BACK_BINDER;
    const src =
      (view === 'front'
        ? (mapFront[color] || mapFront[Object.keys(mapFront)[0]])
        : (mapBack[color]  || mapBack[Object.keys(mapBack)[0]]));
    return loadImage(src);
  }

  // --- DRAW ---
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const base = getBaseImage();
    if(!base || !base.width || !base.height) return;

    const marginX = canvas.width * 0.08;
    const marginY = canvas.height * 0.06;
    const maxW = canvas.width - marginX*2;
    const maxH = canvas.height - marginY*2;
    const ratio = base.height / base.width;

    let W = maxW;
    let H = W * ratio;
    if(H > maxH){
      H = maxH;
      W = H / ratio;
    }

    const sx = (canvas.width - W) / 2;
    const sy = (canvas.height - H) / 2;

    if(base.complete) ctx.drawImage(base,sx,sy,W,H);

    const cx = canvas.width/2;
    const cy = sy + H*0.40;

    layers.forEach(L=>{
      if(!L.img || !L.vis) return;
      const iw = canvas.width * 0.40;
      const ih = iw * (L.img.naturalHeight/Math.max(1,L.img.naturalWidth));
      ctx.save();
      ctx.translate(cx + L.x, cy + L.y);
      ctx.rotate(L.rot * Math.PI/180);
      ctx.scale(L.scale, L.scale);
      ctx.globalAlpha = L.op;
      ctx.drawImage(L.img,-iw/2,-ih/2,iw,ih);
      ctx.restore();
    });
  }

  // --- UPLOAD LAYER ROWS ---
  function renderUploadRows(){
    uploadsBox.innerHTML = '';
    for(let i=0;i<LAYER_COUNT;i++){
      const row = document.createElement('div');
      row.className = 'ld-upload-row';
      row.innerHTML = `
        <div>
          <input type="file" id="ld-file-${i}" accept=".png,.jpg,.jpeg,.svg" class="ld-input">
        </div>
        <label class="hpt24-sw-toggle">
          <input type="checkbox" data-bw="${i}"> S/W 3,50 ‚Ç¨
        </label>
        <button class="ld-btn" data-act="${i}">Aktiv</button>
        <button class="ld-btn" data-vis="${i}">${layers[i].vis?'üëÅ AUS':'üëÅ AN'}</button>
        <button class="ld-btn" data-del="${i}">‚úñ</button>
      `;
      uploadsBox.appendChild(row);

      const inp = row.querySelector(`#ld-file-${i}`);
      inp.addEventListener('change',e=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        const url = URL.createObjectURL(f);
        const im = new Image();
        im.onload = ()=>{
          const prevBw = layers[i].bw || false;
          layers[i] = {
            img:im,x:0,y:0,
            scale:1,rot:0,op:1,
            vis:true,bw:prevBw,
            name:f.name||`Motiv ${i+1}`
          };
          active = i;
          syncUIFromLayer();
          renderUploadRows();
          draw();
          updatePrice();
        };
        im.src = url;
      });

      const swCb = row.querySelector(`[data-bw="${i}"]`);
      swCb.checked = !!layers[i].bw;
      swCb.onchange = ()=>{
        layers[i].bw = swCb.checked;
        updatePrice();
      };

      row.querySelector(`[data-act="${i}"]`).onclick = ()=>{
        active = i;
        syncUIFromLayer();
        renderUploadRows();
      };
      row.querySelector(`[data-vis="${i}"]`).onclick = ()=>{
        if(!layers[i].img) return;
        layers[i].vis = !layers[i].vis;
        draw();
        updatePrice();
        renderUploadRows();
        syncUIFromLayer();
      };
      row.querySelector(`[data-del="${i}"]`).onclick = ()=>{
        layers[i] = makeLayer();
        if(active === i) active = Math.max(0,active-1);
        draw();
        updatePrice();
        renderUploadRows();
        syncUIFromLayer();
      };
    }
  }

  // --- PRESETS ---
  function applyPreset(name){
    const L = layers[active];
    if(!L || !L.img) return;
    if(name === 'center'){
      L.x = 0;
      L.y = 0;
      L.scale = 1;
    }
    if(name === 'back'){
      L.x = 0;
      L.y = -canvas.height * 0.10;
      L.scale = 0.9;
    }
    syncUIFromLayer();
    draw();
  }
  document.querySelectorAll('[data-preset]').forEach(b=>{
    b.addEventListener('click',()=>applyPreset(b.dataset.preset));
  });

  // --- UI SYNC ---
  function syncUIFromLayer(){
    const L = layers[active] || {};
    const scalePct = Math.round((L.scale||1)*100);
    scaleEl.value = scalePct;
    scaleVal.textContent = `(${scalePct}%)`;

    rotEl.value = Math.round(L.rot||0);
    rotVal.textContent = `(${rotEl.value}¬∞)`;

    const opaPct = Math.round((L.op||1)*100);
    opaEl.value = opaPct;
    opaVal.textContent = `(${opaPct}%)`;

    visBtn.textContent = 'Sichtbar: ' + ((L.img && L.vis) ? 'AN' : 'AUS');
  }

  scaleEl.addEventListener('input',()=>{
    const L = layers[active]; if(!L || !L.img) return;
    L.scale = Number(scaleEl.value)/100;
    scaleVal.textContent = `(${scaleEl.value}%)`;
    draw();
  });
  rotEl.addEventListener('input',()=>{
    const L = layers[active]; if(!L || !L.img) return;
    L.rot = Number(rotEl.value);
    rotVal.textContent = `(${rotEl.value}¬∞)`;
    draw();
  });
  opaEl.addEventListener('input',()=>{
    const L = layers[active]; if(!L || !L.img) return;
    L.op = Number(opaEl.value)/100;
    opaVal.textContent = `(${opaEl.value}%)`;
    draw();
  });

  visBtn.addEventListener('click',()=>{
    const L = layers[active]; if(!L || !L.img) return;
    L.vis = !L.vis;
    syncUIFromLayer();
    renderUploadRows();
    draw();
    updatePrice();
  });

  delBtn.addEventListener('click',()=>{
    layers[active] = makeLayer();
    syncUIFromLayer();
    renderUploadRows();
    draw();
    updatePrice();
  });

  // --- DRAG & SCROLL ---
  let dragging = false;
  let last = {x:0,y:0};

  function getPos(e){
    const r = canvas.getBoundingClientRect();
    return {
      x:(e.clientX - r.left) * (canvas.width / r.width),
      y:(e.clientY - r.top)  * (canvas.height / r.height)
    };
  }

  canvas.addEventListener('mousedown',e=>{
    dragging = true;
    last = getPos(e);
  });
  window.addEventListener('mouseup',()=>dragging=false);
  canvas.addEventListener('mousemove',e=>{
    if(!dragging) return;
    const p = getPos(e);
    const dx = p.x - last.x;
    const dy = p.y - last.y;
    const L = layers[active];
    if(L && L.img){
      L.x += dx;
      L.y += dy;
      draw();
    }
    last = p;
  });

  canvas.addEventListener('wheel',e=>{
    const L = layers[active]; if(!L || !L.img) return;
    e.preventDefault();
    if(e.shiftKey){
      L.rot += -Math.sign(e.deltaY)*4;
    }else{
      const cur = L.scale*100;
      let next = cur - Math.sign(e.deltaY)*6;
      next = Math.max(5,Math.min(400,next));
      L.scale = next/100;
    }
    syncUIFromLayer();
    draw();
  }, {passive:false});

  // --- PREISKALKULATION ---
  function motifStats(){
    let bw=0,colorCount=0;
    [layersFront,layersBack].forEach(layerSet=>{
      for(let i=0;i<LAYER_COUNT;i++){
        const L = layerSet[i];
        if(!L || !L.img || !L.vis) continue;
        if(L.bw) bw++;
        else colorCount++;
      }
    });
    return {bw,color:colorCount};
  }

  function computeUnitPrice(){
    const q = selectedQuality || 'standard';
    let base = BASE_PRICE[q] || 0;

    const stats = motifStats();
    const motifCost = stats.bw * MOTIF_PRICE.bw + stats.color * MOTIF_PRICE.color;
    let sum = base + motifCost;

    if(promoDiscount > 0){
      sum = sum - (sum * promoDiscount);
    }
    return sum;
  }

  function fmt(n){return n.toLocaleString('de-DE',{style:'currency',currency:'EUR'});}

  function updatePrice(){
    const qty = Math.max(1,parseInt(qtyEl.value || '1',10));
    const unit = computeUnitPrice();
    priceEl.value = fmt(unit * qty);
  }

  qtyEl.addEventListener('input',updatePrice);

  // --- QUALIT√ÑT BUTTONS (nur Standard) ---
  const qBtns = document.querySelectorAll('.q-btn');
  qBtns.forEach(btn=>{
    btn.addEventListener('click',()=>{
      qBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      selectedQuality = btn.dataset.q || 'standard';
      qualityEl.value = selectedQuality;
      promoDiscount = 0;
      if(promoInput) promoInput.value = '';
      if(promoHint) promoHint.style.display = 'none';
      renderColorSelect();
      renderSwatches();
      updatePrice();
      draw();
    });
  });

  // --- PROMOCODE ---
  if(promoInput){
    promoInput.addEventListener('input',()=>{
      const code = promoInput.value.trim().toLowerCase();
      promoDiscount = 0;
      promoHint.style.display = 'none';

      if(code === 'hp24-10') promoDiscount = 0.10;
      else if(code === 'hp24-20') promoDiscount = 0.20;
      else if(code === 'free')   promoDiscount = 1.00;

      if(promoDiscount > 0) promoHint.style.display = 'block';
      updatePrice();
    });
  }

  // --- WARENKORB ---
  function renderCart(){
    cartBox.innerHTML = '';
    let sum = 0;
    cart.forEach((it,idx)=>{
      sum += it.unit * it.qty;
      const row = document.createElement('div');
      row.className = 'ld-cart-row';
      row.innerHTML = `
        <div>
          <strong>${it.name}</strong>
          <span class="ld-chip">${COLOR_NAME[it.color] || it.color}</span>
          <span class="ld-chip">${it.size || '-'}</span>
          <span class="ld-chip">${it.quality}</span>
          <span class="ld-chip">${it.motifs} Motiv${it.motifs===1?'':'e'}</span>
        </div>
        <div>${fmt(it.unit)}</div>
        <div>
          <button class="ld-btn" data-a="${idx}">‚àí</button>
          <span>${it.qty}</span>
          <button class="ld-btn" data-b="${idx}">+</button>
        </div>
        <button class="ld-btn" data-x="${idx}">Entfernen</button>
      `;
      cartBox.appendChild(row);
    });

    totalEl.textContent = fmt(sum);

    cartBox.querySelectorAll('[data-a]').forEach(b=>{
      b.onclick = ()=>{
        const i = +b.dataset.a;
        cart[i].qty = Math.max(1,cart[i].qty-1);
        renderCart();
      };
    });
    cartBox.querySelectorAll('[data-b]').forEach(b=>{
      b.onclick = ()=>{
        const i = +b.dataset.b;
        cart[i].qty++;
        renderCart();
      };
    });
    cartBox.querySelectorAll('[data-x]').forEach(b=>{
      b.onclick = ()=>{
        cart.splice(+b.dataset.x,1);
        renderCart();
      };
    });
  }

  document.getElementById('ld-add').addEventListener('click',()=>{
    const size = sizeEl.value || '-';
    const qty  = Math.max(1,parseInt(qtyEl.value || '1',10));
    const stats = motifStats();
    const motifsCount = stats.bw + stats.color;
    const unitPrice = computeUnitPrice();

    cart.push({
      name:'Binder PokePate',
      color,
      size,
      qty,
      quality:selectedQuality,
      motifs:motifsCount,
      unit:unitPrice
    });
    renderCart();
    updatePrice();
  });

  document.getElementById('ld-download').addEventListener('click',()=>{
    const a = document.createElement('a');
    a.download = `HomePrint24_BinderPokePate_${COLOR_NAME[color] || color}_${view}.png`;
    a.href = canvas.toDataURL('image/png');
    a.click();
  });

  document.getElementById('ld-checkout').addEventListener('click',()=>{
    window.location.href = 'https://www.homeprint24.com/';
  });

  // INIT
  function init(){
    selectedQuality = 'standard';
    qualityEl.value = selectedQuality;
    renderColorSelect();
    renderSwatches();
    renderUploadRows();
    syncUIFromLayer();
    updatePrice();
    setView('front');
    draw();
  }
  init();
})();
</script>
</body>
</html>
