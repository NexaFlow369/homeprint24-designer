<!-- HomePrint24 ‚Äì PRINT YOUR LEGACY: Designer v7.9 (Back getrennt, Kids 25 %, Preset inline, Preview links, Fjalla One) -->
<div id="hpt24">
  <h2 class="hpt24-title">HomePrint24 ‚Äî Print Your Legacy</h2>

  <!-- Produkt-Tabs -->
  <div id="hpt24-tabs">
    <button data-prod="tshirt" class="ld-tab active">T-Shirt</button>
    <button data-prod="vneck"  class="ld-tab">V-Ausschnitt</button>
    <button data-prod="polo"   class="ld-tab">Polo Shirt</button>
    <button data-prod="hoodie" class="ld-tab">Hoodie</button>
    <button data-prod="sweat"  class="ld-tab">Sweatshirt</button>
    <button data-prod="track"  class="ld-tab">Trainingsjacke</button>
    <button data-prod="jogger" class="ld-tab">Jogginghose</button>
  </div>

  <div class="hpt24-layout">
    <!-- LINKE SPALTE: Livebild + Layer-Controls -->
    <div class="hpt24-left">
      <div class="ld-preview-shell">
        <canvas id="ld-canvas" width="760" height="920"></canvas>
        <div class="ld-preview-hint">
          Tipp: Ziehen = Position ‚Ä¢ Mausrad/Pinch = Skalierung (aktiver Layer)
        </div>
        <div class="ld-color-bar">
          <span class="ld-sublabel">Farbe (Vorschau)</span>
          <div id="ld-swatches" class="ld-swatches-row"></div>
        </div>
      </div>

      <!-- Layer- und Motiv-Controls unter dem Livebild -->
      <div class="ld-card ld-layer-card">
        <div class="hpt24-grid-2 hpt24-gap-top">
          <div>
            <!-- PRESET IN EINER REIHE: "Preset: Center  Back-Tag" -->
            <div class="hpt24-preset-wrap">
              <span class="ld-sublabel">Preset:</span>
              <div class="hpt24-preset-row">
                <button data-preset="center" class="ld-btn">Center</button>
                <button data-preset="back"   class="ld-btn">Back-Tag</button>
              </div>
            </div>
          </div>
          <div>
            <label class="ld-sublabel">
              Skalierung <span id="ld-scale-val" class="hpt24-subval">(100%)</span>
            </label>
            <input id="ld-scale" type="range" min="5" max="400" value="100" class="hpt24-range">
          </div>
        </div>

        <div class="hpt24-grid-3">
          <div>
            <label class="ld-sublabel">
              Rotation <span id="ld-rot-layer-val" class="hpt24-subval">(0¬∞)</span>
            </label>
            <input id="ld-rot-layer" type="range" min="-180" max="180" value="0" class="hpt24-range">
          </div>
          <div>
            <label class="ld-sublabel">
              Deckkraft <span id="ld-opa-val" class="hpt24-subval">(100%)</span>
            </label>
            <input id="ld-opa" type="range" min="5" max="100" value="100" class="hpt24-range">
          </div>
          <div class="hpt24-layer-buttons">
            <button id="ld-layer-vis" class="ld-btn hpt24-small-btn">Sichtbar: AN</button>
            <button id="ld-layer-del" class="ld-btn hpt24-small-btn" title="Layer entfernen">Entf.</button>
          </div>
        </div>
      </div>
    </div>

    <!-- RECHTE SPALTE: Upload, Bestellangaben, Warenkorb -->
    <div class="hpt24-right">
      <!-- Upload-Card -->
      <div class="ld-card">
        <div class="hpt24-row-between">
          <label class="ld-label" style="margin:0;">Dein Motiv hochladen:</label>
          <div class="hpt24-view-switch">
            <span class="ld-sublabel">Ansicht:</span>
            <span id="ld-view-badge" class="ld-badge">FRONT</span>
            <button id="ld-toggle-back" class="ld-btn">Back</button>
          </div>
        </div>
        <div id="ld-uploader-list" class="hpt24-upload-list"></div>
      </div>

      <!-- Bestellangaben -->
      <div class="ld-card">
        <label class="ld-label">Bestellangaben</label>

        <div class="hpt24-grid-2 hpt24-gap-top">
          <select id="ld-size" class="ld-input">
            <option value="">Gr√∂√üe w√§hlen</option>
            <!-- Kindergr√∂√üen -->
            <option value="110-116" data-kid="1">110‚Äì116</option>
            <option value="122-128" data-kid="1">122‚Äì128</option>
            <option value="134-140" data-kid="1">134‚Äì140</option>
            <option value="146-152" data-kid="1">146‚Äì152</option>
            <option value="158-164" data-kid="1">158‚Äì164</option>
            <!-- Erwachsenengr√∂√üen ‚Äì Frau bekommt zus√§tzlich XXS/XS -->
            <option value="XXS" data-kid="0" data-woman="1">XXS</option>
            <option value="XS"  data-kid="0" data-woman="1">XS</option>
            <option value="S"   data-kid="0">S</option>
            <option value="M"   data-kid="0">M</option>
            <option value="L"   data-kid="0">L</option>
            <option value="XL"  data-kid="0">XL</option>
            <option value="XXL" data-kid="0">XXL</option>
            <option value="3XL" data-kid="0">3XL</option>
          </select>
          <select id="ld-color-select" class="ld-input">
            <option value="w">Wei√ü</option>
            <option value="s">Schwarz</option>
            <option value="g">Gelb</option>
            <option value="b">Blau</option>
            <option value="r">Rot</option>
          </select>
        </div>

        <div class="hpt24-grid-2 hpt24-gap-top">
          <select id="ld-quality" class="ld-input">
            <option value="basic">Qualit√§t: Basic</option>
            <option value="standard">Qualit√§t: Standard</option>
            <option value="premium">Qualit√§t: Premium</option>
          </select>
          <select id="ld-gender" class="ld-input">
            <option value="">Passform w√§hlen</option>
            <option value="man">Mann</option>
            <option value="woman">Frau</option>
            <option value="kid">Kind</option>
          </select>
        </div>

        <p id="ld-kid-note" class="hpt24-kid-note" style="display:none;">
          Hinweis: Bei ‚ÄûKind‚Äú wird der Textilpreis rabattiert (25 %), die Druckkosten pro Motiv bleiben unver√§ndert.
        </p>

        <div class="hpt24-gap-top">
          <label class="ld-sublabel"></label>
          <p class="hpt24-print-hint">
          </p>
        </div>

        <div class="hpt24-grid-2 hpt24-gap-top">
          <input id="ld-qty" type="number" min="1" value="1" class="ld-input" placeholder="St√ºckzahl">
          <input id="ld-price" type="text" class="ld-input" value="0,00 ‚Ç¨" readonly>
        </div>

        <textarea id="ld-notes" class="ld-input hpt24-notes" placeholder="W√ºnsche/Anmerkungen (z. B. 25 cm Breite, √Ñrmel rechts ‚Ä¶)"></textarea>

        <div class="hpt24-grid-2 hpt24-gap-top">
          <button id="ld-add" class="ld-btn primary">In den Warenkorb</button>
          <button id="ld-download" class="ld-btn">Mockup herunterladen</button>
        </div>
      </div>

      <!-- Warenkorb unter Bestellangaben -->
      <div class="ld-card ld-cart-card">
        <div class="hpt24-row-between">
          <div class="ld-label" style="margin:0;">Warenkorb</div>
          <div id="ld-total" class="hpt24-total">0,00 ‚Ç¨</div>
        </div>
        <div id="ld-cart" class="hpt24-cart-list"></div>
        <button id="ld-checkout" class="ld-btn accent hpt24-checkout-btn">Zur Kasse</button>
        <p class="hpt24-hint-text">
          Hinweis: Der Gesamtpreis basiert auf Produkt, Qualit√§t, Motivanzahl und Druckart. Mockup bitte vor dem Checkout herunterladen.
        </p>
      </div>
    </div>
  </div>

  <p class="hpt24-footer">¬© HomePrint24 ‚Äî Print Your Legacy</p>
</div>

<!-- Checkout-Suggest-Modal -->
<div id="ld-suggest-modal">
  <div class="ld-modal-inner">
    <button id="ld-modal-close" class="ld-modal-close">√ó</button>
    <div class="ld-modal-header">
      <div class="ld-modal-logo">HP</div>
      <div>
        <h3>Dein Motiv ‚Äì weitere Farbvarianten</h3>
        <p>So k√∂nnte dein Motiv auf deinem gew√§hlten Produkt in anderen Farben aussehen.</p>
      </div>
    </div>

    <div class="ld-modal-grid">
      <div class="ld-modal-item">
        <canvas id="ld-modal-variant-1" width="180" height="220"></canvas>
        <div class="ld-modal-label">Variante 1 ‚Äì andere Farbe</div>
      </div>
      <div class="ld-modal-item">
        <canvas id="ld-modal-variant-2" width="180" height="220"></canvas>
        <div class="ld-modal-label">Variante 2 ‚Äì andere Farbe</div>
      </div>
      <div class="ld-modal-item">
        <canvas id="ld-modal-variant-3" width="180" height="220"></canvas>
        <div class="ld-modal-label">Variante 3 ‚Äì andere Farbe</div>
      </div>
    </div>

    <p class="ld-modal-hint">
      Hinweis: Das Motiv ist eine Vorschau. Du kannst sp√§ter weitere Produkte mit deinem Logo anfragen.
    </p>

    <div class="ld-modal-actions">
      <button id="ld-modal-skip" class="ld-btn">Sp√§ter entscheiden</button>
      <button id="ld-modal-checkout" class="ld-btn primary">Direkt zur Kasse</button>
    </div>
  </div>
</div>

<style>
/* Google Font: Fjalla One */
@import url('https://fonts.googleapis.com/css2?family=Fjalla+One&display=swap');

/* Designer-Block hellgrau */
#hpt24{
  max-width:1080px;
  margin:24px auto;
  font-family:'Fjalla One',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  background:#e5e7eb;
  padding:16px;
  border-radius:18px;
}
#hpt24 *,#ld-suggest-modal *{
  box-sizing:border-box;
  font-family:'Fjalla One',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
}
.hpt24-title{text-align:center;margin:8px 0 16px;color:#0f172a;font-weight:800;letter-spacing:.3px;}
#hpt24-tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:12px;}
.hpt24-layout{
  display:grid;
  grid-template-columns:minmax(0,1.05fr) minmax(0,1.25fr);
  gap:18px;
  align-items:stretch;
}
.hpt24-left,
.hpt24-right{
  display:flex;
  flex-direction:column;
  gap:12px;
}
.hpt24-right{
  border-left:1px solid #e5e7eb;
  padding-left:14px;
}
.ld-card{background:#f9fafb;border-radius:12px;padding:14px;border:1px solid #e5e7eb;}
.ld-label{font-weight:800;color:#0f172a;margin-bottom:4px;}
.ld-sublabel{font-weight:600;color:#0f172a;font-size:13px;}
.ld-input{padding:10px;border:1px solid #cbd5e1;border-radius:8px;width:100%;background:#fff;font-size:13px;}
.ld-tab{padding:8px 12px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;cursor:pointer;font-weight:700;font-size:12px;}
.ld-tab.active{background:#1D3557;color:#fff;border-color:#1D3557;}
.ld-btn{padding:6px 9px;border:none;border-radius:8px;background:#e2e8f0;font-weight:600;font-size:11px;cursor:pointer;}
.ld-btn.primary,.ld-btn.accent{padding:9px 14px;font-size:13px;font-weight:800;}
.ld-btn.primary{background:#1D3557;color:#fff;}
.ld-btn.accent{background:#0ea5e9;color:#fff;}
.ld-badge{font-size:12px;color:#64748b;}
.ld-chip{padding:2px 8px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;font-size:11px;}
.hpt24-upload-list{display:flex;flex-direction:column;gap:8px;margin-top:10px;}
.ld-upload-row{
  display:grid;
  grid-template-columns:minmax(0,1.6fr) auto auto auto auto;
  gap:5px;
  align-items:center;
}
.ld-upload-row .ld-btn{padding:4px 7px;font-size:10px;}
.hpt24-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.hpt24-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px;}
.hpt24-gap-top{margin-top:8px;}
.hpt24-range{width:100%;}
.hpt24-subval{font-size:12px;color:#64748b;}
.hpt24-layer-buttons{display:flex;gap:6px;align-items:flex-end;justify-content:flex-end;}
.hpt24-small-btn{padding:5px 8px;font-size:11px;}
.hpt24-row-between{display:flex;justify-content:space-between;align-items:center;}
.hpt24-view-switch{display:flex;gap:8px;align-items:center;}
.hpt24-radio-col{margin-top:4px;font-size:12px;display:flex;flex-direction:column;gap:2px;}
.hpt24-notes{height:84px;margin-top:8px;}
.hpt24-kid-note{margin-top:6px;font-size:11px;color:#f97316;}
.hpt24-print-hint{font-size:11px;color:#4b5563;margin-top:4px;line-height:1.5;}

/* PRESET INLINE: "Preset: Center Back-Tag" */
.hpt24-preset-wrap{
  display:flex;
  align-items:center;
  gap:8px;
  margin-top:4px;
}
.hpt24-preset-row{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}

/* CART ‚Äì Eintr√§ge hellgrau & sauber angeordnet */
.ld-cart-row{
  display:grid;
  grid-template-columns:minmax(0,1.6fr) auto auto auto;
  gap:10px;
  align-items:center;
  background:#e5e7eb;
  border:1px solid #cbd5e1;
  border-radius:12px;
  padding:10px;
}
.ld-cart-card{
  margin:4px auto 0;
  border-top:2px solid #0f172a;
  box-shadow:0 6px 18px rgba(15,23,42,.1);
  padding-top:10px;
  max-width:520px;
  width:100%;
}
.hpt24-total{font-weight:800;color:#0f172a;}
.hpt24-cart-list{margin-top:8px;display:flex;flex-direction:column;gap:8px;}
.hpt24-checkout-btn{margin-top:12px;width:100%;}
.hpt24-hint-text{font-size:11px;color:#64748b;margin-top:6px;}

.ld-preview-shell{
  position:relative;
  background:#fff;
  border-radius:14px;
  box-shadow:0 10px 32px rgba(15,23,42,.12);
  padding:8px 8px 12px;
  display:flex;
  flex-direction:column;
  gap:10px;
  max-width:520px;
  width:100%;
  margin:0 auto;
}
#ld-canvas{
  width:92%;
  display:block;
  margin:0 auto;
  border-radius:12px;
  background:#ffffff;
}
.ld-preview-hint{position:absolute;left:16px;bottom:60px;background:rgba(15,23,42,.78);color:#fff;padding:6px 10px;border-radius:8px;font-size:12px;}
.ld-color-bar{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:6px 8px;border-radius:10px;background:#f9fafb;border:1px solid #e5e7eb;}
.ld-swatches-row{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
.hpt24-footer{text-align:center;font-size:12px;color:#64748b;margin-top:10px;}

.hpt24-sw-toggle{
  font-size:10px;
  display:flex;
  align-items:center;
  gap:4px;
  color:#111827;
  white-space:nowrap;
}
.hpt24-sw-toggle input{
  margin:0;
}

/* Layer-Card unter Canvas */
.ld-layer-card{
  max-width:520px;
  margin:0 auto;
}

@media(max-width:900px){
  .hpt24-layout{grid-template-columns:1fr;}
  .hpt24-right{
    border-left:none;
    padding-left:0;
  }
  .ld-preview-shell{max-width:100%;}
  .ld-layer-card{max-width:100%;}
  .ld-cart-card{max-width:100%;}
  .ld-preview-hint{bottom:56px;}
  .ld-color-bar{flex-direction:column;align-items:flex-start;}
  .ld-swatches-row{justify-content:flex-start;}
}

@media(max-width:600px){
  .ld-cart-row{
    grid-template-columns:1fr 1fr;
    grid-auto-rows:auto;
  }
}

/* Modal */
#ld-suggest-modal{display:none;position:fixed;inset:0;background:rgba(15,23,42,.72);z-index:9999;align-items:center;justify-content:center;padding:16px;}
.ld-modal-inner{background:#f9fafb;border-radius:18px;max-width:780px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.35);padding:18px 20px 16px;position:relative;}
.ld-modal-close{position:absolute;top:10px;right:10px;border:none;border-radius:999px;width:28px;height:28px;cursor:pointer;background:#e5e7eb;font-weight:800;font-size:16px;line-height:1;}
.ld-modal-header{display:flex;align-items:center;gap:10px;margin-bottom:6px;}
.ld-modal-logo{width:32px;height:32px;border-radius:999px;background:#0f172a;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:14px;}
.ld-modal-header h3{margin:0;font-size:18px;font-weight:800;color:#0f172a;}
.ld-modal-header p{margin:2px 0 0;font-size:12px;color:#64748b;}
.ld-modal-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:10px;}
.ld-modal-item{text-align:center;}
.ld-modal-item canvas{width:100%;border-radius:10px;background:#f3f4f6;}
.ld-modal-label{font-size:12px;margin-top:4px;font-weight:600;color:#0f172a;}
.ld-modal-hint{font-size:11px;color:#64748b;margin-top:8px;}
.ld-modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px;}
</style>

<script>
(function(){
  const PRODUCT_GROUP={tshirt:'shirt',vneck:'shirt',polo:'shirt',sweat:'sweat',hoodie:'sweat',jogger:'bottom',track:'bottom'};

  /* PREISE nach deiner Matrix (NETTO) */
  const BASE_PRICE = {
    // T-Shirt, V-Neck, Polo
    shirt: {
      basic:   19.99,
      standard:25.99,
      premium: 35.99
    },
    // Hoodie, Sweatshirt
    sweat: {
      basic:   29.99,
      standard:35.99,
      premium: 45.99
    },
    // Trainingsjacke, Jogginghose
    bottom: {
      basic:   29.99,
      standard:35.99,
      premium: 45.99
    }
  };

  const MOTIF_PRICE={bw:3.50,color:5.50};
  const COLOR_NAME={w:'Wei√ü',s:'Schwarz',g:'Gelb',b:'Blau',r:'Rot'};
  const COLORS=['w','s','g','b','r'];

  const L = u => u;
  const mk8 = url => [url,url,url,url,url,url,url,url];

  const SPIN = {
    tshirt:{
      w:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_8859-22fc80e.jpeg')),
      s:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/9044523B-C19F-4A0F-B862-B86EF2545897.PNG')),
      g:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/E05E563E-7D63-4FD1-A4E2-24F60D507FA8.PNG')),
      b:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_8715.JPG')),
      r:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/B2A51331-A2B9-4532-AA80-EBB34F73F9F1.PNG'))
    },
    vneck:{
      w:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_8857-67c38c7.jpeg')),
      s:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/E7078B3D-B6CD-49DC-B1EC-4B89FE644512.PNG')),
      g:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/A49EC79F-165D-451A-B892-9D990C18B1A8.PNG')),
      b:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_8703.JPG')),
      r:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/0348FC77-95B0-4887-ACC4-58B5AC340725.PNG'))
    },
    polo:{
      w:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_8861-93371b9.jpeg')),
      s:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/CF07D465-AD70-4B59-B4C9-C56C71D50A8A.PNG')),
      g:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/A122CC2F-2845-4AE3-95DE-F7A1D8596251.PNG')),
      b:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_8704.JPG')),
      r:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/DBFEE0D6-17EA-494C-9983-6A80D5797620.PNG'))
    },
    sweat:{
      w:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_8851-9a0d6be.jpeg')),
      s:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/F0801048-59C8-4317-8808-ABEE9047DBD9.PNG')),
      g:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/4D612398-6100-4B74-ABA4-1D3181EC7A8B.PNG')),
      b:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_8706.JPG')),
      r:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/432C0138-1D4D-497D-B18F-66FF8A2795BD.PNG'))
    },
    hoodie:{
      w:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_8854-eb3c161.jpeg')),
      s:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/74A41EA4-CD5A-4F5D-B29A-A6CF73C239CB.PNG')),
      g:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/1F1F6B9F-DE7F-4FE5-B2FE-0B0902FE4AD6.PNG')),
      b:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_8705.JPG')),
      r:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/0F574FD6-DF22-4DB6-A726-DFE8249BEFD0.PNG'))
    },
    track:{
      w:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/A27C407C-FC1D-4410-A9DC-575CAB439359.PNG')),
      s:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/F12B652D-DA9B-4723-89EC-DCA4A832DA5A.PNG')),
      g:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/B5F31336-FD47-440A-9EB1-5394930690FD.PNG')),
      b:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_8707.JPG')),
      r:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/B467D182-0751-4F2D-A446-8AD9BD5D2A22.PNG'))
    },
    jogger:{
      w:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_8856-46eccc7.jpeg')),
      s:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/81A36E17-2F38-49AC-AC78-C3E219625711.PNG')),
      g:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/654A46F2-1A7E-494E-8A0A-2265425B0FDE.PNG')),
      b:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_8708.JPG')),
      r:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/4964EDDF-73AB-4CF0-B917-CDF8F6626036.PNG'))
    }
  };

  const SPIN_BACK={
    tshirt:{
      w:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_8858-794c71d.jpeg')),
      b:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/DB6435C5-9AF3-4FB8-A7B6-39F9DC638153.png')),
      r:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/8F018B1D-CC6E-4C06-8122-F92859D6D2AA.png')),
      g:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/3D4B59F3-F697-4B50-ABE3-DD8929D492EE.png')),
      s:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/08C825A8-7588-4EFF-B501-B4B17C49B0AE.png'))
    },
    vneck:{
      w:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_8858-794c71d.jpeg')),
      b:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/DB6435C5-9AF3-4FB8-A7B6-39F9DC638153.png')),
      r:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/8F018B1D-CC6E-4C06-8122-F92859D6D2AA.png')),
      g:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/3D4B59F3-F697-4B50-ABE3-DD8929D492EE.png')),
      s:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/08C825A8-7588-4EFF-B501-B4B17C49B0AE.png'))
    },
    polo:{
      w:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_8860-4130231.jpeg')),
      b:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/A51B266B-F250-4100-A137-AA55E7C77CED.png')),
      r:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/E2058E22-9504-4DA3-A03E-C63C57D15F77.png')),
      g:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/9E059962-0148-42FF-AAAE-9721A75D0A2A.png')),
      s:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/766DB5AE-29AC-4CAA-AFD4-56B2B3684514.png'))
    },
    sweat:{
      w:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_8747.jpeg')),
      b:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/92444697-F97F-4A54-B16F-F2FE4811DD54.png')),
      r:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/B8C64A98-36E3-4409-9500-4E50A3F04FDF.png')),
      g:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/ADDF4343-6BE8-469E-86F1-ED8ABA70CF8F.png')),
      s:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/C8048577-4000-4816-B003-45E0CF1ED3E1.png'))
    },
    hoodie:{
      w:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_8853-a6c6bdf.jpeg')),
      b:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/C6A2641C-228E-49BF-9C18-818668CBD38C.png')),
      r:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/BA1189AE-1B6-42AC-96CB-59E9FB086453.png')),
      g:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/C7C44B04-3E08-4E0F-953D-100F164A27D3.png')),
      s:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/06A96D19-6648-4D49-A422-5656B5AB4F03.png'))
    },
    track:{
      w:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_8852-d43b693.jpeg')),
      b:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/E4559EF7-479B-40C4-A541-BCE82C453F70.png')),
      r:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/D562B05D-392B-4A80-A0B0-C7F7703AA965.png')),
      g:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/A707EC48-6F41-408F-A726-745443635383.png')),
      s:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/D386B573-20F6-44EA-A931-C78B79CEDD4D.png'))
    },
    jogger:{
      w:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/IMG_8855-2363b65.jpeg')),
      b:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/08D5390F-60DD-4360-B196-3B12BD2CD5AD.png')),
      r:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/A74DAE2D-6CEB-402E-B752-07FC04E9D059.png')),
      g:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/D4E2597C-A792-40C6-9591-247AC18E267B.png')),
      s:mk8(L('https://img1.wsimg.com/isteam/ip/b7f2d84f-ac0c-40e3-8f17-c80a8147cdc6/ols/8B18318E-8B54-468C-997E-D83C33D59366.png'))
    }
  };

  const canvas=document.getElementById('ld-canvas');
  const ctx=canvas.getContext('2d');
  let prod='tshirt',color='w',frame=0,frames=[];
  let view='front';

  const LAYER_COUNT=3;
  const makeLayer=()=>({img:null,x:0,y:0,w:0,rot:0,scale:1,op:1,vis:true,bw:false,name:''});
  const layersFront=Array.from({length:LAYER_COUNT},makeLayer);
  const layersBack=Array.from({length:LAYER_COUNT},makeLayer);
  let layers=layersFront,active=0;

  const priceEl=document.getElementById('ld-price');
  const qtyEl=document.getElementById('ld-qty');
  const colorSel=document.getElementById('ld-color-select');
  const qualityEl=document.getElementById('ld-quality');
  const genderEl=document.getElementById('ld-gender');
  const sizeEl=document.getElementById('ld-size');
  const kidNoteEl=document.getElementById('ld-kid-note');
  const scaleEl=document.getElementById('ld-scale');
  const scaleVal=document.getElementById('ld-scale-val');
  const rotLayerEl=document.getElementById('ld-rot-layer');
  const rotLayerVal=document.getElementById('ld-rot-layer-val');
  const opaEl=document.getElementById('ld-opa');
  const opaVal=document.getElementById('ld-opa-val');
  const uploadsBox=document.getElementById('ld-uploader-list');
  const badgeEl=document.getElementById('ld-view-badge');
  const toggleBackBtn=document.getElementById('ld-toggle-back');
  const checkoutBtn=document.getElementById('ld-checkout');
  const totalEl=document.getElementById('ld-total');

  const modalEl=document.getElementById('ld-suggest-modal');
  const modalCloseBtn=document.getElementById('ld-modal-close');
  const modalSkipBtn=document.getElementById('ld-modal-skip');
  const modalCheckoutBtn=document.getElementById('ld-modal-checkout');

  const IMAGE_CACHE={};
  const cart=[];

  function fmt(n){return n.toLocaleString('de-DE',{style:'currency',currency:'EUR'});}

  function loadImage(src){
    if(IMAGE_CACHE[src]) return IMAGE_CACHE[src];
    const im=new Image();
    im.crossOrigin='anonymous';
    im.onload=()=>draw();
    im.src=src;
    IMAGE_CACHE[src]=im;
    return im;
  }

  function getFrameSet(){
    const map=(view==='back' && SPIN_BACK[prod] && SPIN_BACK[prod][color])?SPIN_BACK:SPIN;
    const arr=(map[prod]&&map[prod][color])?map[prod][color]:SPIN[prod].w;
    return arr.map(loadImage);
  }

  function baseOverlayW(){return Math.round(canvas.width*0.38);}

  function allLayers(){
    return [...layersFront,...layersBack];
  }

  // Pro Slot nur 1 Motiv (Front+Back zusammengez√§hlt)
  function motifStats(){
    let bw = 0;
    let colorCount = 0;

    for(let i=0;i<LAYER_COUNT;i++){
      const F = layersFront[i];
      const B = layersBack[i];

      const hasImg =
        (F && F.img && F.vis) ||
        (B && B.img && B.vis);

      if(!hasImg) continue;

      const isBw =
        (F && F.img && F.vis && F.bw) ||
        (B && B.img && B.vis && B.bw);

      if(isBw) bw++;
      else colorCount++;
    }

    return { bw, color: colorCount };
  }

  function computeMotifCost(){
    const s=motifStats();
    return s.bw*MOTIF_PRICE.bw + s.color*MOTIF_PRICE.color;
  }

  /* PREISLOGIK: Blanko + Motive, Kinder-Rabatt nur auf Blanko (25 %) */
  function computeUnitPrice(){
    const group=PRODUCT_GROUP[prod]||'shirt';
    const quality=(qualityEl&&qualityEl.value)||'basic';

    let base=(BASE_PRICE[group]&&BASE_PRICE[group][quality])?BASE_PRICE[group][quality]:0;

    if(genderEl && genderEl.value==='kid'){
      base*=0.75; // 25 % Rabatt nur auf Textil
    }

    const motifCost=computeMotifCost();
    return base+motifCost;
  }

  function updatePrice(){
    const qty=Math.max(1,parseInt(qtyEl.value||'1',10));
    const unit=computeUnitPrice();
    priceEl.value=fmt(unit*qty);
  }

  /* Kindergr√∂√üen nur bei ‚ÄûKind‚Äú, XXS/XS nur bei ‚ÄûFrau‚Äú */
  function applyKidSizeLock(){
    if(!sizeEl) return;
    const genderVal = genderEl ? genderEl.value : '';
    const isKid = genderVal === 'kid';
    let firstEnabled=null;

    Array.from(sizeEl.options).forEach(o=>{
      if(!o.value){
        o.disabled=false;
        return;
      }
      const isChildOpt   = o.dataset.kid === '1';
      const isWomanOnly  = o.dataset.woman === '1';
      let enable = false;

      if(isKid){
        // Nur Kindergr√∂√üen
        enable = isChildOpt;
      }else if(genderVal === 'woman'){
        // Alle Erwachsenengr√∂√üen, inkl. XXS/XS
        enable = !isChildOpt;
      }else if(genderVal === 'man'){
        // Erwachsene, aber ohne Frau-only (XXS/XS)
        enable = !isChildOpt && !isWomanOnly;
      }else{
        // Noch keine Passform gew√§hlt: alles deaktiviert au√üer Placeholder
        enable = false;
      }

      o.disabled = !enable;
      if(enable && !firstEnabled) firstEnabled=o;
    });

    if(genderVal === 'kid' || genderVal === 'woman' || genderVal === 'man'){
      sizeEl.value = firstEnabled ? firstEnabled.value : '';
    }else{
      sizeEl.value = '';
    }

    if(kidNoteEl) kidNoteEl.style.display = isKid ? 'block' : 'none';
    updatePrice();
  }

  function loadFrames(){frames=getFrameSet();frame=0;draw();}

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const base=frames[Math.floor(frame)%frames.length]||{};
    if(!base.width||!base.height) return;

    const marginX=canvas.width*0.07,marginY=canvas.height*0.06;
    const maxW=canvas.width-marginX*2,maxH=canvas.height-marginY*2;
    const ratio=base.height/base.width;
    let W=maxW,H=W*ratio;
    if(H>maxH){H=maxH;W=H/ratio;}
    const sx=(canvas.width-W)/2,sy=(canvas.height-H)/2;
    if(base.complete) ctx.drawImage(base,sx,sy,W,H);

    const cx=canvas.width/2;
    const centerFactor=(prod==='jogger')?0.62:0.46;
    const cy=sy+H*centerFactor;

    layers.forEach(L=>{
      if(!L.img||!L.vis) return;
      const iw=L.w||baseOverlayW();
      const r=L.img.naturalHeight/Math.max(1,L.img.naturalWidth);
      const ih=iw*r;
      ctx.save();
      ctx.translate(cx+L.x,cy+L.y);
      ctx.rotate((L.rot||0)*Math.PI/180);
      ctx.scale(L.scale||1,L.scale||1);
      ctx.globalAlpha=L.op||1;
      ctx.drawImage(L.img,-iw/2,-ih/2,iw,ih);
      ctx.restore();
    });
  }

  document.querySelectorAll('#hpt24 .ld-tab').forEach(b=>{
    b.onclick=()=>{
      document.querySelectorAll('#hpt24 .ld-tab').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      prod=b.dataset.prod;
      colorSel.value=color;
      loadFrames();
      updatePrice();
    };
  });

  function renderSwatches(){
    const host=document.getElementById('ld-swatches');
    host.innerHTML='';
    COLORS.forEach(k=>{
      const hex=({w:'#ffffff',s:'#0f172a',g:'#fbbf24',b:'#2563eb',r:'#ef4444'})[k];
      const el=document.createElement('div');
      el.title=COLOR_NAME[k];
      el.style.width='28px';el.style.height='28px';
      el.style.borderRadius='50%';
      el.style.border='2px solid #cbd5e1';
      el.style.cursor='pointer';
      el.style.background=hex;
      el.onclick=()=>{color=k;colorSel.value=k;loadFrames();};
      host.appendChild(el);
    });
  }
  colorSel.addEventListener('change',e=>{color=e.target.value;loadFrames();});

  /* WICHTIG: Front & Back NICHT mehr automatisch kopieren */
  function setView(v){
    view = (v === 'back') ? 'back' : 'front';
    layers = (view === 'front') ? layersFront : layersBack;
    badgeEl.textContent = view.toUpperCase();
    active = 0;
    renderUploadRows();
    syncUIFromLayer();
    loadFrames();
  }
  toggleBackBtn.addEventListener('click',()=>{setView(view==='front'?'back':'front');});

  function renderUploadRows(){
    uploadsBox.innerHTML='';
    for(let i=0;i<LAYER_COUNT;i++){
      const row=document.createElement('div');
      row.className='ld-upload-row';
      row.innerHTML=`
        <div>
          <input id="ld-file-${i}" type="file" accept=".png,.jpg,.jpeg,.svg" class="ld-input">
        </div>
        <label class="hpt24-sw-toggle">
          <input type="checkbox" data-bw="${i}">
          S/W 3,50 ‚Ç¨
        </label>
        <button class="ld-btn" data-act="${i}">Aktiv</button>
        <button class="ld-btn" data-vis="${i}">${layers[i].vis?'üëÅ AUS':'üëÅ AN'}</button>
        <button class="ld-btn" data-del="${i}" title="Entfernen">‚úñ</button>
      `;
      uploadsBox.appendChild(row);

      const inp=row.querySelector(`#ld-file-${i}`);
      inp.addEventListener('change',e=>{
        const f=e.target.files&&e.target.files[0];
        if(!f) return;
        const url=URL.createObjectURL(f);
        const im=new Image();
        im.onload=()=>{
          const prevBw = layers[i].bw || false;
          layers[i]={img:im,x:0,y:0,w:baseOverlayW(),rot:0,scale:1,op:1,vis:true,bw:prevBw,name:f.name||`Layer ${i+1}`};
          active=i;
          syncUIFromLayer();
          renderUploadRows();
          draw();
          updatePrice();
        };
        im.src=url;
      });

      const swCb=row.querySelector(`[data-bw="${i}"]`);
      swCb.checked=!!layers[i].bw;
      swCb.onchange=()=>{
        layers[i].bw = swCb.checked;
        updatePrice();
      };

      row.querySelector(`[data-act="${i}"]`).onclick=()=>{active=i;syncUIFromLayer();renderUploadRows();};
      row.querySelector(`[data-vis="${i}"]`).onclick=()=>{
        if(!layers[i].img) return;
        layers[i].vis=!layers[i].vis;
        if(active===i) syncUIFromLayer();
        renderUploadRows();
        draw();
        updatePrice();
      };
      row.querySelector(`[data-del="${i}"]`).onclick=()=>{
        layers[i]=makeLayer();
        if(active===i) active=Math.max(0,active-1);
        syncUIFromLayer();
        renderUploadRows();
        draw();
        updatePrice();
      };
    }
  }

  function applyPreset(name){
    const L=layers[active];if(!L.img) return;
    const H=canvas.height;
    if(name==='center'){L.w=baseOverlayW();L.x=0;L.y=0;}
    if(name==='back'){L.w=Math.round(baseOverlayW()*0.7);L.x=0;L.y=H*-0.30;}
    draw();syncUIFromLayer();
  }
  document.querySelectorAll('#hpt24 [data-preset]').forEach(b=>b.addEventListener('click',()=>applyPreset(b.dataset.preset)));

  function syncUIFromLayer(){
    const L=layers[active]||{};
    const scalePct=Math.round((L.scale||1)*100);
    scaleEl.value=Math.min(400,Math.max(5,scalePct||100));
    scaleVal.textContent=`(${scaleEl.value}%)`;
    rotLayerEl.value=Math.round(L.rot||0);
    rotLayerVal.textContent=`(${rotLayerEl.value}¬∞)`;
    opaEl.value=Math.round((L.op||1)*100);
    opaVal.textContent=`(${opaEl.value}%)`;
    document.getElementById('ld-layer-vis').textContent='Sichtbar: '+((L.img&&L.vis)?'AN':'AUS');
  }
  scaleEl.addEventListener('input',()=>{const L=layers[active];if(!L||!L.img)return;L.scale=Number(scaleEl.value)/100;scaleVal.textContent=`(${scaleEl.value}%)`;draw();});
  rotLayerEl.addEventListener('input',()=>{const L=layers[active];if(!L||!L.img)return;L.rot=Number(rotLayerEl.value);rotLayerVal.textContent=`(${rotLayerEl.value}¬∞)`;draw();});
  opaEl.addEventListener('input',()=>{const L=layers[active];if(!L||!L.img)return;L.op=Number(opaEl.value)/100;opaVal.textContent=`(${opaEl.value}%)`;draw();});
  document.getElementById('ld-layer-vis').addEventListener('click',()=>{
    const L=layers[active];if(!L||!L.img)return;
    L.vis=!L.vis;
    syncUIFromLayer();
    renderUploadRows();
    draw();
    updatePrice();
  });
  document.getElementById('ld-layer-del').addEventListener('click',()=>{
    layers[active]=makeLayer();
    renderUploadRows();
    syncUIFromLayer();
    draw();
    updatePrice();
  });

  let dragging=false,last={x:0,y:0};
  function getPos(e){const r=canvas.getBoundingClientRect();return{x:(e.clientX-r.left)*(canvas.width/r.width),y:(e.clientY-r.top)*(canvas.height/r.height)};}
  canvas.addEventListener('mousedown',e=>{dragging=true;last=getPos(e);});
  window.addEventListener('mouseup',()=>dragging=false);
  canvas.addEventListener('mousemove',e=>{
    if(!dragging) return;
    const p=getPos(e),dx=p.x-last.x,dy=p.y-last.y;
    const L=layers[active];
    if(L&&L.img){L.x+=dx;L.y+=dy;draw();}
    last=p;
  });
  canvas.addEventListener('wheel',e=>{
    const L=layers[active];if(!L||!L.img)return;
    e.preventDefault();
    const cur=Number(scaleEl.value);
    const next=Math.max(5,Math.min(400,cur-Math.sign(e.deltaY)*6));
    scaleEl.value=next;L.scale=next/100;scaleVal.textContent=`(${next}%)`;draw();
  });

  const cartBox=document.getElementById('ld-cart');
  function addToCart(it){cart.push(it);renderCart();}
  function renderCart(){
    cartBox.innerHTML='';
    let sum=0;
    cart.forEach((it,idx)=>{
      sum+=it.price*it.qty;
      const row=document.createElement('div');
      row.className='ld-cart-row';
      const qualLabel=(it.quality||'basic').charAt(0).toUpperCase()+(it.quality||'basic').slice(1);
      const motifsText=(it.motifs||0)+' Motiv'+(it.motifs===1?'':'e');
      row.innerHTML=`
        <div>
          <strong>${it.name}</strong>
          <span class="ld-chip">${COLOR_NAME[it.color]||it.color}</span>
          <span class="ld-chip">${it.size||'-'}</span>
          <span class="ld-chip">${qualLabel}</span>
          <span class="ld-chip">${motifsText}</span>
        </div>
        <div class="ld-cart-price">${fmt(it.price)}</div>
        <div class="ld-cart-qty">
          <button class="ld-btn" data-a="${idx}">‚àí</button>
          <div>${it.qty}</div>
          <button class="ld-btn" data-b="${idx}">+</button>
        </div>
        <button class="ld-btn ld-cart-remove" data-x="${idx}">Entfernen</button>
      `;
      cartBox.appendChild(row);
    });
    totalEl.textContent=fmt(sum);
    cartBox.querySelectorAll('[data-a]').forEach(b=>b.onclick=()=>{const i=+b.dataset.a;cart[i].qty=Math.max(1,cart[i].qty-1);renderCart();});
    cartBox.querySelectorAll('[data-b]').forEach(b=>b.onclick=()=>{const i=+b.dataset.b;cart[i].qty++;renderCart();});
    cartBox.querySelectorAll('[data-x]').forEach(b=>b.onclick=()=>{cart.splice(+b.dataset.x,1);renderCart();});
  }

  document.getElementById('ld-add').onclick=()=>{
    const size=sizeEl.value||'-';
    const qty=Math.max(1,parseInt(qtyEl.value||'1',10));
    const name=({tshirt:'T-Shirt',vneck:'V-Ausschnitt',polo:'Polo Shirt',hoodie:'Hoodie',sweat:'Sweatshirt',track:'Trainingsjacke',jogger:'Jogginghose'})[prod];
    const quality=qualityEl.value||'basic';
    const gender=genderEl.value||'';
    const stats = motifStats();
    const motifsCount = stats.bw + stats.color;
    const unitPrice=computeUnitPrice();
    addToCart({name,prod,color,size,qty,price:unitPrice,quality,gender,motifs:motifsCount});
    updatePrice();
  };

  qtyEl.addEventListener('input',updatePrice);
  qualityEl.addEventListener('change',updatePrice);
  genderEl.addEventListener('change',()=>{applyKidSizeLock();});

  /* Placement im Modal pro Produkttyp */
  const MODAL_PLACEMENT={
    tshirt:{w:0.34,x:0.5,y:0.33},
    vneck:{w:0.34,x:0.5,y:0.33},
    polo:{w:0.34,x:0.5,y:0.33},
    sweat:{w:0.34,x:0.5,y:0.33},
    hoodie:{w:0.36,x:0.5,y:0.32},
    track:{w:0.34,x:0.5,y:0.33},
    jogger:{w:0.30,x:0.55,y:0.62}
  };

  function getFirstMotifLayer(){
    return allLayers().find(L=>L.img && L.vis);
  }

  function drawModalVariantCanvas(id,prodKey,colorKey){
    const cvs=document.getElementById(id);if(!cvs)return;
    const c=cvs.getContext('2d');
    c.clearRect(0,0,cvs.width,cvs.height);

    const prodSpin=SPIN[prodKey];
    if(!prodSpin) return;
    const arr = (prodSpin[colorKey] || prodSpin['w'] || Object.values(prodSpin)[0]);
    if(!arr) return;
    const baseImg=loadImage(arr[0]);
    if(!baseImg.complete){baseImg.onload=()=>drawModalVariantCanvas(id,prodKey,colorKey);return;}

    const maxW=cvs.width*0.8,maxH=cvs.height*0.7;
    const ratio=baseImg.height/baseImg.width;
    let W=maxW,H=W*ratio;
    if(H>maxH){H=maxH;W=H/ratio;}
    const sx=(cvs.width-W)/2,sy=5;
    c.drawImage(baseImg,sx,sy,W,H);

    const layer=getFirstMotifLayer();
    if(!layer || !layer.img) return;
    const motif=layer.img;

    const conf=MODAL_PLACEMENT[prodKey] || {w:0.34,x:0.5,y:0.35};
    const scaleFactor=Math.max(0.5,Math.min(1.5,layer.scale||1));
    const mw=W*conf.w*scaleFactor;
    const mh=mw*(motif.naturalHeight/Math.max(1,motif.naturalWidth));
    const mx=sx + W*conf.x - mw/2;
    const my=sy + H*conf.y - mh/2;

    c.save();
    c.globalAlpha=layer.op || 1;
    c.drawImage(motif,mx,my,mw,mh);
    c.restore();
  }

  function getSuggestColors(){
    const available = COLORS.filter(k => SPIN[prod] && SPIN[prod][k]);
    if(!available.length) return [color,color,color];
    const others = available.filter(k=>k!==color);
    const result = [];
    if(others.length>=3){
      return others.slice(0,3);
    }
    result.push(...others);
    available.forEach(k=>{
      if(result.length<3 && !result.includes(k)) result.push(k);
    });
    while(result.length<3) result.push(color);
    return result.slice(0,3);
  }

  function renderModalPreviews(){
    const cols=getSuggestColors();
    drawModalVariantCanvas('ld-modal-variant-1',prod,cols[0]);
    drawModalVariantCanvas('ld-modal-variant-2',prod,cols[1]);
    drawModalVariantCanvas('ld-modal-variant-3',prod,cols[2]);
  }

  function openModal(){
    if(!modalEl) return;
    modalEl.style.display='flex';
    renderModalPreviews();
  }
  function closeModal(){if(modalEl) modalEl.style.display='none';}

  modalCloseBtn && modalCloseBtn.addEventListener('click',closeModal);
  modalSkipBtn && modalSkipBtn.addEventListener('click',closeModal);

  function redirectToCheckout(){
    const url='https://www.homeprint24.com/';
    window.location.href=url;
  }
  modalCheckoutBtn && modalCheckoutBtn.addEventListener('click',redirectToCheckout);

  let checkoutStage=0;
  checkoutBtn.addEventListener('click',()=>{
    if(checkoutStage===0){
      openModal();
      checkoutStage=1;
      checkoutBtn.textContent='Weiter zur Kasse';
    }else{
      redirectToCheckout();
    }
  });

  document.getElementById('ld-download').onclick=()=>{
    const a=document.createElement('a');
    a.download=`HomePrint24_${prod}_${COLOR_NAME[color]||color}_${view}.png`;
    a.href=canvas.toDataURL('image/png');
    a.click();
  };

  function init(){
    renderSwatches();
    loadFrames();
    renderUploadRows();
    syncUIFromLayer();
    setView('front');
    applyKidSizeLock();
    updatePrice();
  }
  init();
})();
</script>
<!-- /Designer v7.9 (mit XXS/XS nur f√ºr Frau) -->